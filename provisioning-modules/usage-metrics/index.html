<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Usage Metrics - WHMCS Developer Documentation</title>
    <meta name="generator" content="Hugo 0.17" />

    
    <meta name="description" content="WHMCS developer documentation - themes, modules, hooks, oauth, api and more...">
    
    <link rel="canonical" href="//developers.whmcs.com/provisioning-modules/usage-metrics/">
    
    <meta name="author" content="WHMCS Development Team">
    

    <link rel="stylesheet" href="//developers.whmcs.com/css/bootstrap.min.css">
    <link rel="stylesheet" href="//developers.whmcs.com/css/styles.css?v=3">
    <link rel="stylesheet" href="//developers.whmcs.com/css/font-awesome.min.css">
    <link rel="stylesheet" href="//developers.whmcs.com/css/prism.css">

    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:400,700">

    

  </head>
  <body class="language-php">

<header class="header">





<div class="container">
<nav class="navbar navbar-whmcs">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#primary-nav" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://www.whmcs.com/"><img src="//developers.whmcs.com/img/logo.png" width="148" height="34"></a>
    </div>

    <div class="collapse navbar-collapse" id="primary-nav">
      <ul class="nav navbar-nav">
        <li><a href="//developers.whmcs.com/"><span class="hidden-sm">Developer Documentation</span><span class="visible-sm">Developer Docs</span></a></li>
        <li class="visible-xs"><a href="//developers.whmcs.com/">Home</a></li>
            <li class="visible-xs"><a href="//developers.whmcs.com/themes/">Themes</a></li>
            <li class="visible-xs"><a href="//developers.whmcs.com/languages/">Languages</a></li>
            <li class="visible-xs active"><a href="//developers.whmcs.com/modules/">Modules</a></li>
            <li class="visible-xs"><a href="//developers.whmcs.com/oauth/">OAuth</a></li>
            <li class="visible-xs"><a href="//developers.whmcs.com/hooks/">Hooks</a></li>
            <li class="visible-xs"><a href="//developers.whmcs.com/api/">API</a></li>
            <li class="visible-xs"><a href="//developers.whmcs.com/advanced/">Advanced</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="//developers.whmcs.com/api2/">API 2 <small class="beta-tag">BETA</small></a></li>
        <li><a href="//developers.whmcs.com/hooks-reference/">Hook Reference</a></li>
        <li><a href="https://github.com/whmcs" target="_blank"><i class="fa fa-github"></i></a></li>
      </ul>
      <form class="navbar-form navbar-right visible-xs" id="docsSearchMobile">
        <div class="aa-input-container" id="aa-input-container">
            <input type="search" id="inputSearchMobile" class="aa-input-search" placeholder="Search documentation" name="search" autocomplete="off" />
            <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
                <path d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
            </svg>
        </div>
      </form>
    </div>
  </div>
</nav>
</div>

<div class="headline-bar hidden-xs">
<nav class="navbar navbar-main-nav">
  <div class="container">
    <div class="collapse navbar-collapse" id="secondary-nav">
      <ul class="nav navbar-nav">
        <li><a href="//developers.whmcs.com/">Home</a></li>
            <li><a href="//developers.whmcs.com/themes/">Themes</a></li>
            <li><a href="//developers.whmcs.com/languages/">Languages</a></li>
            <li class="active"><a href="//developers.whmcs.com/modules/">Modules</a></li>
            <li><a href="//developers.whmcs.com/oauth/">OAuth</a></li>
            <li><a href="//developers.whmcs.com/hooks/">Hooks</a></li>
            <li><a href="//developers.whmcs.com/api/">API</a></li>
            <li><a href="//developers.whmcs.com/advanced/">Advanced</a></li>
      </ul>
      <form class="navbar-form navbar-right" id="docsSearch">
        <div class="aa-input-container" id="aa-input-container">
            <input type="search" id="inputSearch" class="aa-input-search" placeholder="Search documentation" name="search" autocomplete="off" />
            <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
                <path d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
            </svg>
        </div>
      </form>
    </div>
  </div>
</nav>
</div>

</header>


<main class="main">

  <div class="container">
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-sm-3 sidebar-offcanvas">

        
          <ul class="sidebar-nav">
            
  <li class="active parent" data-nav-id="/provisioning-modules/">
    
    <a href="//developers.whmcs.com/provisioning-modules/">
      <span>
        
          <i class='fa fa-cog fa-fw'></i>
        
         Provisioning Modules
       </span>
    </a>
    
    <ul>
      
      
      
      
        <li class="" data-nav-id="/provisioning-modules/getting-started/">
          <a href="//developers.whmcs.com/provisioning-modules/getting-started/">
            <span>Getting Started</span>
          </a>
        </li>
      
      
      
        <li class="" data-nav-id="/provisioning-modules/config-options/">
          <a href="//developers.whmcs.com/provisioning-modules/config-options/">
            <span>Configuration Options</span>
          </a>
        </li>
      
      
      
        <li class="" data-nav-id="/provisioning-modules/simple-mode/">
          <a href="//developers.whmcs.com/provisioning-modules/simple-mode/">
            <span>Simple Mode</span>
          </a>
        </li>
      
      
      
        <li class="" data-nav-id="/provisioning-modules/loader-functions/">
          <a href="//developers.whmcs.com/provisioning-modules/loader-functions/">
            <span>Loader Functions</span>
          </a>
        </li>
      
      
      
        <li class="" data-nav-id="/provisioning-modules/meta-data-params/">
          <a href="//developers.whmcs.com/provisioning-modules/meta-data-params/">
            <span>Meta Data Parameters</span>
          </a>
        </li>
      
      
      
        <li class="" data-nav-id="/provisioning-modules/supported-functions/">
          <a href="//developers.whmcs.com/provisioning-modules/supported-functions/">
            <span>Supported Functions</span>
          </a>
        </li>
      
      
      
        <li class="" data-nav-id="/provisioning-modules/module-parameters/">
          <a href="//developers.whmcs.com/provisioning-modules/module-parameters/">
            <span>Module Parameters</span>
          </a>
        </li>
      
      
      
        <li class="" data-nav-id="/provisioning-modules/core-module-functions/">
          <a href="//developers.whmcs.com/provisioning-modules/core-module-functions/">
            <span>Core Module Functions</span>
          </a>
        </li>
      
      
      
        <li class="" data-nav-id="/provisioning-modules/single-sign-on/">
          <a href="//developers.whmcs.com/provisioning-modules/single-sign-on/">
            <span>Single Sign-On</span>
          </a>
        </li>
      
      
      
        <li class="" data-nav-id="/provisioning-modules/usage-update/">
          <a href="//developers.whmcs.com/provisioning-modules/usage-update/">
            <span>Usage Update</span>
          </a>
        </li>
      
      
      
        <li class="active" data-nav-id="/provisioning-modules/usage-metrics/">
          <a href="//developers.whmcs.com/provisioning-modules/usage-metrics/">
            <span>Usage Metrics</span>
          </a>
        </li>
      
      
      
        <li class="" data-nav-id="/provisioning-modules/custom-functions/">
          <a href="//developers.whmcs.com/provisioning-modules/custom-functions/">
            <span>Custom Functions</span>
          </a>
        </li>
      
      
      
        <li class="" data-nav-id="/provisioning-modules/client-area-output/">
          <a href="//developers.whmcs.com/provisioning-modules/client-area-output/">
            <span>Client Area Output</span>
          </a>
        </li>
      
      
      
        <li class="" data-nav-id="/provisioning-modules/admin-services-tab/">
          <a href="//developers.whmcs.com/provisioning-modules/admin-services-tab/">
            <span>Admin Services Tab</span>
          </a>
        </li>
      
      
      
        <li class="" data-nav-id="/provisioning-modules/admin-dashboard-widgets/">
          <a href="//developers.whmcs.com/provisioning-modules/admin-dashboard-widgets/">
            <span>Admin Dashboard Widgets</span>
          </a>
        </li>
      
      
      
        <li class="" data-nav-id="/provisioning-modules/module-logging/">
          <a href="//developers.whmcs.com/provisioning-modules/module-logging/">
            <span>Module Logging</span>
          </a>
        </li>
      
      
      
        <li class="" data-nav-id="/provisioning-modules/server-sync/">
          <a href="//developers.whmcs.com/provisioning-modules/server-sync/">
            <span>Server Sync</span>
          </a>
        </li>
      
      
    </ul>
    
  </li>


          </ul>
        

      </div>
      <div class="col-sm-9">

        <div class="breadcrumb-nav">

            <div class="pull-right">
              <a class="suggest-an-edit" href="https://github.com/WHMCS/developer-docs" target="blank">
                <i class="fa fa-code-fork"></i>
                <span class="hidden-xs">Suggest an edit</span>
              </a>
            </div>

            <div class="visible-xs pull-left">
                <button type="button" class="btn btn-toggle-sidebar" data-toggle="offcanvas">
                    <i class="fa fa-list-alt"></i>
                </button>
            </div>

            <div id="breadcrumbs">
                
                
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                    
                    
                <a href="//developers.whmcs.com/provisioning-modules/" itemprop="url"><span itemprop="title">Provisioning Modules</span></a> <i class="fa fa-angle-right"></i>
                    
                  
                
                  
                
                <span itemprop="title"> Usage Metrics</span>
              </div>
            </div>


			<h1>Usage Metrics </h1>

			

<p><code>Compatibility: This functionality is available since v7.9</code></p>

<p>Usage metrics give Services information about resource consumption and Products
the ability to price those resources.</p>

<p>Please make sure to read the feature documentation for
<a href="https://docs.whmcs.com/Usage_Billing">Usage Billing</a> so that you have the best
understanding of how your module is expected to interact with WHMCS.</p>

<h2 id="metricprovider-function">MetricProvider Function</h2>

<p>The MetricProvider function is responsible for returning an object that implements
\WHMCS\UsageBilling\Contracts\Metrics\ProviderInterface.</p>

<p>This object provides a list of available metrics, all usage of the server, and
usage by given tenant on that server.
Interface and class are documented in the WHMCS\UsageBilling namespace at <a href="https://classdocs.whmcs.com/">https://classdocs.whmcs.com/</a></p>

<p>The following illustrates how one might make a simple class that fulfills the interface</p>

<pre><code>namespace WHMCS\Module\Server\Mymodule;
/**
 * The above namespace is automatically registered for autoloading classes within
 * a &quot;lib&quot; sub-directory relative to your module directory. So, place this class 
 * in modules/servers/mymodule/lib/MyMtricsProvider.php. 
 */

use WHMCS\UsageBilling\Contracts\Metrics\MetricInterface;
use WHMCS\UsageBilling\Contracts\Metrics\ProviderInterface;
use WHMCS\UsageBilling\Metrics\Metric;
use WHMCS\UsageBilling\Metrics\Units\Accounts;
use WHMCS\UsageBilling\Metrics\Usage;

class MyMetricsProvider implements ProviderInterface
{
    private $moduleParams = [];
    public function __construct($moduleParams)
    {
        // A sample `$params` array may be defined as:
        //
        // ```
        // array(
        //     &quot;server&quot; =&gt; true
        //     &quot;serverid&quot; =&gt; 1
        //     &quot;serverip&quot; =&gt; &quot;11.111.4.444&quot;
        //     &quot;serverhostname&quot; =&gt; &quot;my.testserver.tld&quot;
        //     &quot;serverusername&quot; =&gt; &quot;root&quot;
        //     &quot;serverpassword&quot; =&gt; &quot;&quot;
        //     &quot;serveraccesshash&quot; =&gt; &quot;ZZZZ1111222333444555AAAA&quot;
        //     &quot;serversecure&quot; =&gt; true
        //     &quot;serverhttpprefix&quot; =&gt; &quot;https&quot;
        //     &quot;serverport&quot; =&gt; &quot;77777&quot;
        // )
        // ```
        $this-&gt;moduleParams = $moduleParams;
    }

    public function metrics()
    {
        return [
            new Metric(
                'emailaddr',
                'Email Mailboxes',
                MetricInterface::TYPE_SNAPSHOT,
                new Accounts('Mailboxes')
            ),
        ];
    }

    public function usage()
    {
        $serverData = $this-&gt;apiCall('stats');
        $usage = [];
        foreach ($serverData as $data) {
            $usage[$data['username']] = $this-&gt;wrapUserData($data);
        }
        
        return $usage;
    }
    
    public function tenantUsage($tenant)
    {
        $userData = $this-&gt;apiCall('user_stats');
        
        return $this-&gt;wrapUserData($userData);
    }

    private function wrapUserData($data)
    {
        $wrapped = [];
        foreach ($this-&gt;metrics() as $metric) {
            $key = $metric-&gt;systemName();
            if ($data[$key]) {
                $value = $data[$key];
                $metric = $metric-&gt;withUsage(
                    new Usage($value)
                );
            }
            
            $wrapped[] = $metric;
        }
        
        return $wrapped;
    }
    
    private function apiCall($action)
    {
        // make remote call with $moduleParams
    }
}
</code></pre>

<p>The MetricProvider function will be invoked in various contexts throughout WHMCS
so it is important to utilize strategies in your class design that minimize
communication with remote servers.  The usage() and tenantUsage() methods will
only be invoked in the context of a service with a server.  However, the metrics()
method will be invoked in contexts specifically about Products. This method
must always return a valid list for all potential servers that use the module.</p>

<h3 id="example-metricprovider-function-a-id-example-function-a">Example MetricProvider Function <a id="example-function"></a></h3>

<pre><code>use WHMCS\Module\Server\MyModule\MyMetricsProvider;

function mymodule_MetricProvider($params) {

    return new MyMetricProvider($params);
}
</code></pre>

<h2 id="metrics">Metrics</h2>

<p>The metric() method must return an array of \WHMCS\UsageBilling\Contracts\Metrics\MetricInterface
instances, as noted by the ProviderInterface.  You may use, or extend, \WHMCS\UsageBilling\Metrics\Metric</p>

<h3 id="metric-type">Metric Type</h3>

<p>The metric type of your MetricInterface instance is a critical expression of
if/when the remote system is resetting the usage data.  If the incorrect type is
used the snapshot data stored within WHMCS may track usage incorrectly.</p>

<p>For metrics that are related to non-ephemeral entities, such as mailboxes, disk
usage, or databases, your remote system is unlikely to reset this data.  These
are a &ldquo;snapshot&rdquo; type (\WHMCS\UsageBilling\Contracts\Metrics\MetricInterface::TYPE_SNAPSHOT)</p>

<p>For metrics that are related to usage that is an accumulative measure at the
remote system, like bandwidth, it is likely that these will be reset of a
specific frequency.  WHMCS support a &ldquo;time-based&rdquo; daily and a monthly frequency via \WHMCS\UsageBilling\Contracts\Metrics\MetricInterface::TYPE_PERIOD_DAY
and \WHMCS\UsageBilling\Contracts\Metrics\MetricInterface::TYPE_PERIOD_MONTH. When data
is collected by WHMCS, the value of these metrics will overwrite any previous
data for the respective time period.  So for monthly items, WHMCS internals will
manage one record for each calendar month; for daily, WHMCS will manage on
record for each day of each month.  At the end of a service&rsquo;s billing term, any
uninvoiced usage for those periods will be summed and calculations applied to
that total.</p>

<h3 id="metric-units">Metric Units</h3>

<p>Several unit classes are readily available in the \WHMCS\UsageBilling\Metrics\Units
namespace.  These include Bytes, MegaBytes, GigaBytes, Accounts, and Domains.  These
extend one of the two base concrete classes, WholeNumber or FloatingPoint. You can use
those directly or extend them with your own concrete definition if you have need
for repeated use of a custom unit.</p>

<h2 id="usage">Usage</h2>

<p>Metrics should describe usage by providing an object that implements
\WHMCS\UsageBilling\Contracts\Metrics\UsageInterface.
You may use \WHMCS\UsageBilling\Metrics\Usage if you wish.  You will provide this
usage detail via the usage() and tenantUsage() methods.</p>

<p>If usage values returned by your API are not in the units that you wish WHMCS to
report has, you will need to manage any conversion.</p>

<p>The usage() method should return an array of tenants and a list of metrics with
usage (in the form of an object instance that implements \WHMCS\UsageBilling\Contracts\Metrics\UsageInterface).
This method is use in a global context, such as by the cron when polling for all
metric information.</p>

<p>The tenantUsage($tenant) should simply provide the list of MetricInterface objects
 that have been populated with UsageInterface objects.  This method
is used in specific contexts of a service.</p>


			<div class="topic-navigation clearfix">
                
                    <a class="nav nav-prev" href="//developers.whmcs.com/provisioning-modules/usage-update">
                        <i class="fa fa-arrow-circle-left"></i>
                        Previous
                    </a>
                
                
                    <a class="nav nav-next" href="//developers.whmcs.com/provisioning-modules/custom-functions">
                        <i class="fa fa-arrow-circle-right"></i>
                        Next
                    </a>
                
            </div>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>

        </div>
  </div>
</div>
</main>


<footer class="footer">
    <div class="container">
        <div class="row">
            <nav>
                <div class="col-sm-3">
                    <h3>Learn</h3>
                    <ul>
                        <li><a href="//developers.whmcs.com/about/">About WHMCS</a></li>
                        <li><a href="//developers.whmcs.com/about/quick-start/">Quick start</a></li>
                        <li><a href="//developers.whmcs.com/api-reference/">API Reference</a></li>
                        <li><a href="https://docs.whmcs.com/classes/">Classes Reference</a></li>
                        <li><a href="//developers.whmcs.com/about/faq/">FAQ</a></li>
                    </ul>
                </div>
                <div class="col-sm-4">
                    <h3>Contribute</h3>
                    <ul>
                        <li><a href="//developers.whmcs.com/about/contribute/">Contribute</a></li>
                        <li><a href="https://github.com/whmcs/" target="_blank">Github</a></li>
                    </ul>
                </div>
                <div class="col-sm-5">
                    <h3>Stay up to date</h3>
                    <div class="subscribe-form">
                        <p class="muted subscribe-lead">Join our developers mailing list to be kept up-to-date.</p>
                        <div class="alert alert-success sub-success-message hidden" role="alert">
                            <strong>Thank You!</strong> You have been subscribed.
                        </div>
                        <div class="alert alert-danger sub-error-message hidden" role="alert">
                            <strong>Sorry</strong> <span id="error-message-text"></span>
                        </div>
                        <form action="//www.whmcs.com/members/subscribe.php" method="post" id="frmSubscribe">
                            <input type="hidden" name="name" value="Subscriber">
                            <input type="hidden" name="developer" value="dev">
                            <div class="input-group">
                                <input type="email" name="email" class="form-control" placeholder="you@yourdomain.com">
                                <span class="input-group-btn">
                                    <button type="submit" class="btn btn-info">
                                        SUBSCRIBE
                                    </button>
                                </span>
                            </div>
                        </form>
                    </div>
                    <p>
                        We won't spam you.
                    </p>
                </div>
            </nav>
        </div>
        <div class="row">
            <div class="col-md-7">
                <p>Found an error or a typo in these docs? <a href="https://github.com/WHMCS/developer-docs/issues">Submit an issue or a pull request</a></p>
            </div>
            <div class="col-md-5">
                <p class="pull-right">
                    Copyright &copy; WHMCS 2022. All rights reserved.
                    <br>
                </p>
            </div>
        </div>
    </div>
</footer>

<script src="//developers.whmcs.com/js/jquery.min.js"></script>
<script src="//developers.whmcs.com/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script>
<script src="//developers.whmcs.com/js/search.js?v=2"></script>
<script src="//developers.whmcs.com/js/prism.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-22019969-15', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>

